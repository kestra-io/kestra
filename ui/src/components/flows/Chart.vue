<script>
import c3 from "c3";
import { debounce, cloneDeep, defaultsDeep } from "lodash";

export default {
  name: "c3-chart",
  props: {
    startDate: {
      type: Date,
      required: true
    },
    endDate: {
      type: Date,
      required: true
    },
    dateFormat: {
      type: String,
      required: true
    },
    config: {
      type: Object,
      default: () => ({
        axis: {
          x: { type: "category" }
        }
      })
    },
    data: {
      type: Object,
      default: () => ({
        json: [
          {
            startDate: "2020-01-15",
            success: 3,
            failed: 5
          },
          {
            startDate: "2020-01-16",
            success: 4
          }
        ],
        keys: {
          x: "startDate",
          value: ["success", "failed", "created", "running"]
        },
        groups: [["success", "failed", "created", "running"]]
      })
    },
    type: {
      type: String,
      default: "bar"
    }
  },
  methods: {
    getArgs() {
      const size = {
        size: {
          height: 50
        }
      };
      const data = this.getData();
      const config = this.getConfig();

      return defaultsDeep({ data }, size, config);
    },
    getData() {
      const { type } = this;
      const data = cloneDeep(this.data);

      // Fill data for empty days
      data.json = this.fillData(data.json);

      return defaultsDeep({ type }, data);
    },
    getConfig() {
      const config = cloneDeep(this.config);
      const color = {
        pattern: ["#bed863", "#d4664f", "#75bcdd", "#da9461"]
      };
      const axis = {
        y: {
          show: false
        },
        x: {
          show: false,
          type: "category",
          padding: {
            left: 0,
            right: 0
          },
          tick: {
            multiline: true
          }
        }
      };
      const legend = {
        show: false
      };
      const bar = {
        width: {
          ratio: 0.7
        }
        //width: 20
      };

      return defaultsDeep({ axis, color, legend, bar }, config);
    },
    update: debounce(function update() {
      // TODO : Use debounce
      const data = this.getData();
      this.$chart.load(data);
      this.$emit("update", data);
    }, 500),
    transform: debounce(function transform(...args) {
      this.$chart.transform(...args);
    }, 100),
    reload: debounce(function reload() {
      this.$emit("reloading");
      this.$chart.unload();
      this.$nextTick(() => {
        this.update();
      });
    }, 700),
    fillData(data) {
      const dateRange = this.$moment.range(this.startDate, this.endDate);

      let resultMetrics = [];

      for (let day of dateRange.by("days")) {
        let dateFormat = "YYYY-MM-DD";
        var d = day.format(dateFormat);

        let realMetric = data.find(element => element.startDate == d);

        if (realMetric) {
          resultMetrics.push(realMetric);
        } else {
          resultMetrics.push({
            startDate: d,
            success: 0,
            failed: 0,
            created: 0,
            running: 0,
            durationStats: null
          });
        }
      }

      return resultMetrics;
    }
  },
  mounted() {
    const args = this.getArgs();

    this.$chart = c3.generate({
      bindto: this.$refs.root,
      ...args
    });

    this.$emit("init", args);
  },
  beforeDestroy() {
    this.$chart = this.$chart.destroy();
  }
};
</script>

<template>
  <div ref="root" class="chart-root"></div>
</template>

<style src="../../../../node_modules/c3/c3.css"></style>